# VPC Reachability Analyzer でネットワークの到達性の問題を解決してみよう

* このワークでは、VPC Reachability Analyzer を使用して VPC リソースのネットワークの到達性の問題を特定します。

![概要](images/xxx.png)

---
## 準備

* インストラクターが指定した環境で AWS マネジメントコンソールにサインインして下さい。
    - **このワークの環境は、ワークを実施する時間帯のみ使用可能です。**
* AWS マネジメントコンソールで、**指定されたリージョン**を選択した状態にしてください。
* ご自分に割り当てられた **2桁の番号**を覚えておいてください。


---
## ワーク環境の作成

1. AWS マネジメントコンソールのページ上部の **検索**で `cfn` と入力して **CloudFormation** のメニューを選択します。
1. **スタックの作成**　から **新しいリソースを使用（標準）** を選択します。
1. **テンプレートの準備**　で **既存のテンプレートを選択** を選択します。
1. **テンプレートソース**　で **Amazon S3 URL** を選択します。
1. **Amazon S3 URL** に下記の URL を入力します。
    - `https://tnobep-work-public.s3.ap-northeast-1.amazonaws.com/vpc-ra-work/vpc-ra-work-template.yaml`
1. **次へ**　を選択します。
1. **スタック名** に `vpc-ra-stack-<自分の2桁の番号>` を入力します。
1. **パラメータ** の **YOURID** に **自分の2桁の番号** を入力します。 
1. **次へ**　を選択します。
1. ページを下にスクロールして、**AWS CloudFormation によって IAM リソースがカスタム名で作成される場合があることを承認します。** にチェックします。
1. **次へ**　を選択します。
1. **送信**　を選択します。
1. スタックのステータスが **CREATE_COMPLETE** になるまで待ちます。

---
## 起動テンプレートの作成

1. AWS マネジメントコンソールのページ上部の **検索**で `ec2` と入力して **EC2** のメニューを選択します。
1. ページ左側で **インスタンス** の **起動テンプレート** を選択します。
1. **起動テンプレートを作成** を選択します。
1. **起動テンプレート名** に `launch-template-<自分の2桁の番号>` を入力します。
1. **EC2 Auto Scaling で使用できるテンプレートをセットアップする際に役立つガイダンスを提供** にチェックします。
1. **アプリケーションおよび OS イメージ (Amazon マシンイメージ)** で **クイックスタート** を選択します。 
1. **Amazon Linux** を選択します。
1. **ネットワーク設定** の **セキュリティグループ** に　**APSG-<自分の2桁の番号>** を選択します。
1. **高度な詳細** を展開表示します。
1. **IAM インスタンスプロフィール**　で **myInstanceProfile-<自分の2桁の番号>** を選択します。
1. ページを下にスクロールして **ユーザーデータ** に下記を入力します。
   
    ```
    #!/bin/bash
    dnf update -y
    dnf -y install stress-ng
    dnf -y install httpd
    cat <<EOF >> /var/www/html/index.html
    <H1>Welcome to AWS</H1>
    EOF
    chown -R apache: apache /var/www/html
    service httpd start
    chkconfig httpd on
    ```

1. **起動テンプレートを作成**　を選択します。
1. **起動テンプレートを表示**　を選択します。

---
## Auto Scaling Group の作成

1. 作成した起動テンプレートの左のチェックボックスをチェックします。
1. **アクション** から **Auto Scaling グループを作成** を選択します。
1. **Auto Scaling グループ名** に `asg-<自分の2桁の番号>` を入力します。   
1. **次へ**　を選択します。
1. **インスタンスの要件** で **手動でインスタンスタイプを追加する** を選択します。
1. **プライマリインスタンスタイプ** で **t3.micro** を選択します。
1. **インスタンスの購入オプション** の **インスタンスの分散**で スポットに `100` を入力します。
1. **オンデマンドベース容量を含める** のチェックを **解除** します。  
1. **ネットワーク** の **VPC** で **my-VPC-<自分の2桁の番号>**　を選択します。
1. **アベイラビリティーゾーンとサブネット** で下記の **2つのサブネット**を選択します。
    - **PrivateSubnet01-<自分の2桁の番号>**
    - **PrivateSubnet02-<自分の2桁の番号>**
1. **次へ**　を選択します。
1. **既存のロードバランサーにアタッチする** を選択します。
1. **既存のロードバランサーターゲットグループ** で **TargetGroup-<自分の2桁の番号>** を選択します。
1. **ヘルスチェック** で **Elastic Load Balancing のヘルスチェックをオンにする** をチェックします。
1. **次へ**　を選択します。
1. **グループサイズ** で **希望するキャパシティ** に **1** を入力します。
1. **スケーリング** で **最小の希望する容量** に **1** を入力します。
1. **スケーリング** で **最大の希望する容量** に **3** を入力します。
1. **次へ**　を選択します。
1. **次へ**　を選択します。
1. **タグを追加する**　を選択します。
1. **キー**　に `Name` を入力します。
1. **値** に `asg-instance-<自分の2桁の番号>` を入力します。
1. **次へ**　を選択します。
1. **Auto Scaling グループを作成する**　を選択します。

---
## スケーリングポリシーの設定
1. 作成した Auto Scaling グループの名前のリンクを選択します。
1. **オートスケーリング** タブを選択します。
1. **動的スケーリングポリシーを作成する**
1. **ターゲット値** に `30` を入力します。
1. **インスタンスのウォームアップ** に `120` を入力します。
1. **作成**　を選択します。

---
## オートスケーリングの確認
1. ページ左側で **インスタンス** の **インスタンス** を選択します。
1. **asg-instance-<自分の2桁の番号>** という名前のインスタンスの実行中のステータスになっていることを確認します。
1. **asg-instance-<自分の2桁の番号>** という名前のインスタンスのステータスチェックが **3/3 のチェックに合格しました** になるまで待ちます。
1. ブラウザの新しいタブでメモしておいた **ALBDNSName** の URL にアクセスします。
1. Web ページが表示されることを確認します。
1. EC2 のコンソールに戻ります。
1. **asg-instance-<自分の2桁の番号>** という名前のインスタンスのチェックボックスをチェックします。
1. ページ下部の **詳細** で **ライフサイクル** が **spot** であることを確認します。
1. ページ上部の **接続**　を選択します。
1. **セッションマネージャー**　タブを選択します。
1. **接続**　を選択します。
1. ホームディレクトリに移動します。
    ```
    cd
    ```

1. 下記のコマンドで CPU に 10 分間負荷をかけます。
    ```
    stress-ng --cpu 0 --timeout 10m
    ```

1. 10分後、EC2 のコンソールに戻ります。
1. ページ左側で **ダッシュボード** を選択して 右側で **インスタンス (実行中)** を選択します。
1. **asg-instance-<自分の2桁の番号>** という名前のインスタンスの数が増えていることを確認します。
1. **asg-instance-<自分の2桁の番号>** という名前のインスタンスのうち、どれか １つのチェックボックスをチェックします。
1. ページ下部の **詳細** で **ライフサイクル** が **spot** であることを確認します。

---

## Auto Scaling グループの削除
1. ページ左側で **Auto Scaling** の **Auto Scaling グループ** を選択します。
1. **asg-<自分の2桁の番号>** のチェックボックスをチェックします。
1. **アクション** - **削除** を選択します。
1. 確認のダイアログで必要なフレーズを入力して削除を実行します。

---

## 起動テンプレートの削除
1. ページ左側で **インスタンス** の **起動テンプレート** を選択します。
1. **launch-template-<自分の2桁の番号>** のチェックボックスをチェックします。
1. **アクション** - **テンプレートを削除** を選択します。
1. 確認のダイアログで必要なフレーズを入力して削除を実行します。

---

## CloudFormation のスタックの削除
1. CloudFormation のページに切り替えます。
1. **vpc-stack-<自分の2桁の番号>** のラジオボタンを選択します。
1. **削除** を選択して、確認ダイアログで **確認**　を選択します。
   
---
### お疲れさまでした。

* **このワークの環境は、ワークを実施する時間帯のみ使用可能です。**

